#!/bin/bash

CATALOG_IMG="registry.redhat.io/redhat/redhat-operator-index:v4.12"
TMP_DIR="/opt/data/mirror"

# Location to store all the mapping.txt file created by oc-mirror
mkdir operator_images

# Get all Red Hat Operators and their default channel
if [ ! -e redhat_operators.list ]; then
  oc-mirror list operators --catalog=${CATALOG_IMG} > redhat_operators.list
fi

while read -r line
do

  OPERATOR=$(echo "${line}" | awk -F\  '{print $1}')
  DEFAULT_CHANNEL=$(echo "${line}" | awk -F\  '{print $NF}')

  # Skip this process if we already have the mappings file for this operator and channel
  if [ -e "operator_images/${OPERATOR}-${DEFAULT_CHANNEL}-mapping.txt" ]; then
    continue
  fi

  echo "Processing: ${OPERATOR} Channel: ${DEFAULT_CHANNEL}"

  rm -f /tmp/imageset-config.yaml
  rm -rf ${TMP_DIR}
  mkdir ${TMP_DIR}
  rm -rf archives
cat <<EOF > /tmp/imageset-config.yaml
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  local:
    path: ${TMP_DIR}
mirror:
  operators:
    - catalog: ${CATALOG_IMG}
      packages:
      - name: ${OPERATOR}
        channels:
          - name: ${DEFAULT_CHANNEL}
EOF

oc-mirror --config /tmp/imageset-config.yaml --dest-skip-tls --continue-on-error --dry-run file://archives
mv ./archives/oc-mirror-workspace/mapping.txt "operator_images/${OPERATOR}-${DEFAULT_CHANNEL}-mapping.txt"

done < <(tail -n +2 redhat_operators.list) # Ship column names on first line

# Remove the right side of the mapping we don't need
sed -i 's/=.*//' operator_images/*.txt

exit 0
