#!/bin/bash

# Script requires the binary from here: https://github.com/p-rog/cve-analyser.git
# build the go binary and ensure it is in your path

if ! `which cve-analyser 2>&1 > /dev/null`
then
  echo "cve-analyser binary missing"
  exit 1
fi

rm -f cves.txt

echo "Parsing input CSV"

while read -r line
do

  clusterName=$(echo "${line}" | awk -F\, '{print $1}')
  clusterId=$(echo "${line}" | awk -F\, '{print $2}')
  namespace=$(echo "${line}" | awk -F\, '{print $3}')
  namespaceId=$(echo "${line}" | awk -F\, '{print $4}')
  deployment_name=$(echo "${line}" | awk -F\, '{print $5}')
  image_name=$(echo "${line}" | awk -F\, '{print $6}')
  cve=$(echo "${line}" | awk -F\, '{print $7}' | tr -d '"')
  cvss=$(echo "${line}" | awk -F\, '{print $8}')
  if [[ "${image_name}" =~ "@" ]]; then
    image_repo=$(echo "${image_name}" | awk -F\@ '{print $1}' | awk '{sub(/\//," ");$1=$1;print $2}')
  else 
    image_repo=$(echo "${image_name}" | awk -F\: '{print $1}' | awk '{sub(/\//," ");$1=$1;print $2}')
  fi

  #echo "clusterName: ${clusterName}"
  #echo "clusterId: ${clusterId}"
  #echo "namespace: ${namespace}"
  #echo "namespaceId: ${namespaceId}"
  #echo "image_name: ${image_name}"
  #echo "image_repo: ${image_repo}"
  #echo "cve: ${cve}"
  #echo "cvss: ${cvss}"

  echo "${cve},${image_repo}" >> cves.txt

done < <(tail -n +2 ${1})

echo "Generating results for CVE and image pairs"
rm -f adjudications.txt
cve-analyser cves.txt > adjudications.txt

echo "Creating annotated CSV file with results"
# Write out a new CSV file with the added information
rm -f "${1}.anotated"
COLS=$(head -1 ${1})
echo "${COLS}," > "${1}.anotated"
while read -r line
do

  cve=$(echo "${line}" | awk -F\, '{print $7}' | tr -d '"')
  rst=$(grep "${cve}" adjudications.txt | awk -F\| '{print $2}')

  echo "${line},${rst}" >> "${1}.anotated"

done < <(tail -n +2 ${1})

exit 0
