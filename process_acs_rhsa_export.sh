#!/bin/bash

if [ $# -eq 0 ]
then
  echo "Usage: $0 <CSV from ACS>"
  exit 1
fi

INPUT_FILE="${1}"

API="https://catalog.redhat.com/api/containers/v1/repositories/registry/registry.access.redhat.com/repository"

echo "Parsing ACS input CSV"

#while read -r line
#do

#  clusterName=$(echo "${line}" | awk -F\, '{print $1}')
#  clusterId=$(echo "${line}" | awk -F\, '{print $2}')
#  namespace=$(echo "${line}" | awk -F\, '{print $3}')
#  namespaceId=$(echo "${line}" | awk -F\, '{print $4}')
#  deployment_name=$(echo "${line}" | awk -F\, '{print $5}')
#  image_name=$(echo "${line}" | awk -F\, '{print $6}')
#  cve=$(echo "${line}" | awk -F\, '{print $7}' | tr -d '"')
#  cvss=$(echo "${line}" | awk -F\, '{print $8}')
#  if [[ "${image_name}" =~ "@" ]]; then
#    image_repo=$(echo "${image_name}" | awk -F\@ '{print $1}' | awk '{sub(/\//," ");$1=$1;print $2}')
#  else
#    image_repo=$(echo "${image_name}" | awk -F\: '{print $1}' | awk '{sub(/\//," ");$1=$1;print $2}')
#  fi
  # Script doesn't currently use these fields
  #severity=$(echo "${line}" | awk -F\, '{print $9}')
  #component=$(echo "${line}" | awk -F\, '{print $10}')
  #version=$(echo "${line}" | awk -F\, '{print $11}')
  #fixedBy=$(echo "${line}" | awk -F\, '{print $12}')

  #echo "clusterName: ${clusterName}"
  #echo "clusterId: ${clusterId}"
  #echo "namespace: ${namespace}"
  #echo "namespaceId: ${namespaceId}"
  #echo "image_name: ${image_name}"
  #echo "image_repo: ${image_repo}"
  #echo "cve: ${cve}"
  #echo "cvss: ${cvss}"

image_repo="openshift-logging/elasticsearch6-rhel8"
image_metadata_file="metadata/$(echo ${image_repo} | sed 's|/|_|g')_images.json"

#Map the image to an operator to determine what the latest image digest is
#OPERATOR_MAPPING=$(grep -Hl "${image_repo}" operator_images/*.txt)
LATEST_DIGEST=$(grep "${image_repo}" operator_images/*.txt | awk -F\= '{print $1}' | awk -F\@ '{print $NF}')

echo ${LATEST_DIGEST}

# pull all past images if we don't have the file already
if [ ! -e "${image_metadata_file}" ]; then
  curl -s "${API}/${image_repo}/images?page_size=500&page=0" > "${image_metadata_file}"
fi

# find the one that matches the latest image digest in the operator bundle
VULNS=$(jq -c ".data[] | select((.repositories[0].manifest_list_digest == \"${LATEST_DIGEST}\") and .parsed_data.architecture == \"amd64\") | .content_advisory_ids" "${image_metadata_file}")
echo "Vulns in latest: ${VULNS}"

#done < <(tail -n +2 ${INPUT_FILE})
# Skip first line of ACS CSV export which has column names
exit 0
